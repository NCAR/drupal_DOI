<?php

// Define the block that displays the module
function doi_display_block_info() {
  $blocks['doi_display'] = array(
    'info' => t('DOI Display'),
  );
  return $blocks;
}

// Define what is displayed in the module
function doi_display_block_view($delta='') {
  switch ($delta) {
  case 'doi_display':
      $doi = doi_display_get_content();
      $block['subject'] = t("Citation");
      $block['content'] = $doi;
      return $block;
      break;
  }
}

// The subroutine that creates the actual display
// 29 = 9 + length of identifier (including doi:)
function doi_display_get_content() {
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, 'http://ezid.cdlib.org/id/doi:10.5065/D6DR2SJP');
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: xml; charset=UTF-8', 'Content-Length: ' . strlen($input)));
    $output = curl_exec($ch);
    //return $output;

    // Output is returned as a single string containing XML which needs to 
    // be parsed to get to the metadata fields. I did a wget on the url 
    // above to see what is returned to $output
    //$xml1 = explode("datacite:",$output);
    //$xml2 = explode("_created:",$xml1[1]);

    // At this point, $xml2[0] contains the xml table from the ezid page. 
    // What we really want is to use the EZID API to get back the metadata
    //
    //return $xml2[0];

    $xml = explode("%0A" , $output);
    $identifier = $xml[2];
    $creators = $xml[5];
    $publisher = $xml[11];
    $publication_year = $xml[12];
    $resource_type = $xml[13];
    $abstract = $xml[15];
    $contributors = array($xml[19], $xml[22]);
    $dates = $xml[26];
    $rights = $xml[29];
    $geolocations = $xml[33];

    return "EZID output: " . $output;
}
